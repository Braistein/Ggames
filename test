local webhook = "https://discord.com/api/webhooks/1417256801849573397/AQ8ksCpFKSzGPcnc-4CBHTqXwMQ0i6E-J4PN8uh327elJFqcBhT4O02CBI_e4GRnUXuL"
---[[ DO NOT TOUCH] ]---
local blockid = 8644
local maxblockinventory = 180
local rootid = 8746
local botName  = GetLocal().name
local botWorld = GetLocal().world

local function motto(url)
    local handle = io.popen('curl -s "' .. url .. '"')
    if not handle then return false end
    local code = handle:read("*a")
    handle:close()

    if not code or code:match("^%s*$") then return false end

    local tmp = os.tmpname()
    local f = io.open(tmp, "w")
    if not f then return false end
    f:write(code)
    f:close()

    local success, err = pcall(dofile, tmp)
    os.remove(tmp)

    if not success then
        print("Error running fetched code:", err)
    end

    return success -- returns true if the code ran, false if error
end


local rootCount = getCount(8644)

botName = botName:gsub("^`+", ""):gsub("`+$", ""):gsub("^w", "")

local function sendWebhook()
    local currentRoot = getCount(blockid)
    local currentGem = GetLocal().gems

    local payload = string.format([[
    {
      "content": "",
      "embeds": [
        {
          "title": "MottoScript",
          "url": "https://discord.gg/6g3XHNbdP6",
          "color": 15844367,
          "fields": [
            {
              "name": "",
              "value": "**Bot Name:** ||**%s**||"
            },
            {
              "name": "",
              "value": "**World:** ||**%s**||"
            },
            {
              "name": "",
              "value": "**Current Root:** %s"
            },
            {
              "name": "",
              "value": "**Current Gem:** %s"
            }
          ],
          "footer": {
            "text": "by Motto",
            "icon_url": ""
          }
        }
      ]
    }
    ]], botName, botWorld, currentRoot, currentGem)

    SendWebhook(webhook, payload)
end

local function trashitem()
    SendPacket(2,"action|trash\n|itemID|"..rootid) 
    SendPacket(2,"action|dialog_return\ndialog_name|trash_item\nitemID|"..rootid.."|\ncount|"..maxblockinventory)
end

local function Hit(x, y)
    local px = GetLocal().pos_x
    local py = GetLocal().pos_y

    local pkt = {
        type = 3,
        int_data = 18,
        flags = 16,
        int_x = math.floor(px / 32) + x,
        int_y = math.floor(py / 32) + y,
        pos_x = px,
        pos_y = py,
    }
    SendPacketRaw(pkt)
end


local function Collect(range)
    range = (range or 4) * 32
    for __, obj in pairs(GetObjects()) do
        posx = math.abs(GetLocal().pos_x - obj.pos_x)
        posy = math.abs(GetLocal().pos_y - obj.pos_y)
        if posx < range and posy < range then
            local pkt = {
                type = 11,
                pos_x = obj.pos_x,
                pos_y = obj.pos_y,
                int_data = obj.oid,
            }
            SendPacketRaw(pkt)
        end
    end
end


local function AntiMiss()
    for __, tile in pairs(GetTiles()) do
        if tile.fg == blockid and GetItemCount(rootid) <= maxblockinventory then
            FindPath(tile.pos_x, tile.pos_y - 1)
            Sleep(500)
            Hit(0, 1)
            Collect(3)
            Sleep(1000)
            return true
        end
        if GetItemCount(rootid) > maxblockinventory then
            break
        end
    end
    return false
end

local lastPrinted = getCount(blockid)
sendWebhook()
while true do
    AntiMiss()

    local currentCount = getCount(blockid)
    if currentCount <= lastPrinted - 98 then
        sendWebhook()
        lastPrinted = currentCount
    end

    if GetItemCount(rootid) > maxblockinventory then
        trashitem()
    end

    if currentCount == 0 then
        sendWebhook()
    end

    Sleep(500)
end
